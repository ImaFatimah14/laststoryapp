import L from"leaflet";import{fixLeafletIcons}from"../utils/fixLeafletIcons";import API from"../data/api";import Swal from"sweetalert2";import{addPendingStory}from"../utils/idb-helper";export default class AddStoryPresenter{constructor({view:t}){this.view=t,this.map=null,this.marker=null,this.selectedLat=null,this.selectedLon=null,this.capturedPhoto=null,this.stream=null}init(){this.view.initializeElements(),fixLeafletIcons(),this._initMap(),this._bindFormSubmit(),this._bindCameraEvents()}_initMap(){this.map=L.map(this.view.getMapContainer()).setView([-2.5489,118.0149],5),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(this.map),this.map.on("click",(t=>{this.selectedLat=t.latlng.lat,this.selectedLon=t.latlng.lng,this.marker?this.marker.setLatLng(t.latlng):this.marker=L.marker(t.latlng).addTo(this.map),this.view.setLocationInfo(`Lokasi dipilih: ${this.selectedLat.toFixed(4)}, ${this.selectedLon.toFixed(4)}`)}))}_bindCameraEvents(){this.view.onUseCameraClick((async()=>{try{this.stream=await navigator.mediaDevices.getUserMedia({video:!0}),this.view.showStream(this.stream),this.capturedPhoto=null,this.view.hideSnapshot()}catch{Swal.fire("Error","Tidak dapat mengakses kamera.","error")}})),this.view.onCaptureClick((()=>{const t=this.view.getCameraPreview(),e=this.view.createCanvas(t.videoWidth,t.videoHeight);e.getContext("2d").drawImage(t,0,0),e.toBlob((t=>{this.capturedPhoto=new File([t],"capture.jpg",{type:"image/jpeg"});const e=URL.createObjectURL(t);this.view.showSnapshot(e),this.view.stopStream(this.stream)}),"image/jpeg")})),this.view.onFileChange((()=>{this.capturedPhoto=null,this.stream&&this.view.stopStream(this.stream),this.view.hideSnapshot()})),this.view.onDeleteSnapshotClick((()=>{this.capturedPhoto=null,this.view.hideSnapshot()}))}_bindFormSubmit(){this.view.getFormElement().addEventListener("submit",(t=>this._handleSubmit(t)))}async _handleSubmit(t){t.preventDefault(),this.view.setSubmitButtonDisabled(!0);const e=this.view.getDescription(),i=this.capturedPhoto||this.view.getPhotoFile();if(!i)return Swal.fire("Foto Kosong!","Silakan ambil atau pilih foto terlebih dahulu.","warning"),void this.view.setSubmitButtonDisabled(!1);if(null==this.selectedLat||null==this.selectedLon)return Swal.fire("Pilih Lokasi!","Silakan klik lokasi pada peta terlebih dahulu.","warning"),void this.view.setSubmitButtonDisabled(!1);if(navigator.onLine)try{await API.addStory({lat:this.selectedLat,lon:this.selectedLon,description:e,photoFile:i}),Swal.fire("Berhasil!","Cerita berhasil ditambahkan.","success"),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((async t=>{await t.pushManager.getSubscription()&&t.showNotification("Story berhasil dibuat",{body:`Anda telah membuat story baru dengan deskripsi: ${e}`,icon:"/images/logo.png",badge:"/images/logo.png"})})),this.view.navigateToHome()}catch(t){Swal.fire("Gagal",t.message||"Terjadi kesalahan.","error"),this.view.setSubmitButtonDisabled(!1)}else{const t={description:e,lat:this.selectedLat,lon:this.selectedLon,createdAt:Date.now(),name:"Offline User",photoUrl:"",photoFile:i};await addPendingStory(t),Swal.fire("Offline","Cerita disimpan lokal & akan tampil di halaman utama. Kirim ke server saat online.","info"),this.view.navigateToHome()}}async cleanup(){this.stream&&(this.stream.getTracks().forEach((t=>t.stop())),this.stream=null),this.map&&(this.map.remove(),this.map=null,this.marker=null)}}